name: $REDIS_SESSION
version: "0.2"

access_policy:
  read:
   - CREATOR
  update:
   - CREATOR

services:
  - name: redis
    image_name: redis_image
    command: redis-server --tls-port 6379 --port 0 --tls-cert-file /tls/redis.crt --tls-key-file /tls/redis.key --tls-ca-cert-file /tls/ca.crt
    mrenclaves: ["$MRENCLAVE"]
    pwd: /

images:
  - name: redis_image
    injection_files:
       - path: /tls/ca.crt
         content: $$SCONE::session-ca-certificate.chain$$ # Export this session's CA certificate & chain
       - path: /tls/redis.crt
         content: $$SCONE::redis.crt$$
       - path: /tls/redis.key
         content: $$SCONE::redis.key$$
       - path: /tls/client.crt
         content: $$SCONE::redis_client_cert.crt$$
       - path: /tls/client.key
         content: $$SCONE::redis_client_cert.key$$

secrets:
  - name: redis # automatically generate Redis server certificate
    kind: x509
  - name: redis_client_cert # automatically generate client certificate
    kind: x509
    export:
      - $FLASK_SESSION # export client cert/key to client session
  - name: redis_ca_cert # export session CA certificate as Redis CA certificate
    kind: session-ca
    export:
      - $FLASK_SESSION # export the session CA certificate to client session
